services:
  demo-agent:
    build: .
    container_name: demo-agent
    user: "${DOCKER_UID:-1000}:${DOCKER_GID:-1000}"
    env_file: .env
    ports:
      - "${DEMO_AGENT_PORT:-9090}:${DEMO_AGENT_PORT:-9090}"
    volumes:
      - ./app:/app/app
      - ./credentials:/app/credentials
      - ./prompts:/app/prompts
    environment:
      - PYTHONUNBUFFERED=1
      - DEMO_AGENT_HOST=0.0.0.0
      - DEMO_AGENT_PORT=${DEMO_AGENT_PORT:-9090}
      - LOG_DIR=/app/logs
      - GOOGLE_APPLICATION_CREDENTIALS=/app/credentials/google-sa.json
      - GCP_PROJECT_ID=${GCP_PROJECT_ID}
      - GCP_LOCATION=${GCP_LOCATION:-us-central1}
      - MODEL=${MODEL:-gemini-2.5-flash}
      - DATABASE_URL=${DATABASE_URL}
      # Concurrency settings
      - MAX_CONCURRENT_REQUESTS=${MAX_CONCURRENT_REQUESTS:-10}
      # Database pool settings
      - DB_POOL_MIN_SIZE=${DB_POOL_MIN_SIZE:-5}
      - DB_POOL_MAX_SIZE=${DB_POOL_MAX_SIZE:-20}
      - DB_COMMAND_TIMEOUT=${DB_COMMAND_TIMEOUT:-60}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${DEMO_AGENT_PORT:-9090}/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    restart: unless-stopped
    # Concurrency config:
    # - UVICORN_WORKERS: Number of worker processes (default: 4 for production)
    # - Each worker has a ThreadPoolExecutor with 10 threads for Gemini API calls
    # - Total concurrent Gemini calls = WORKERS * 10 = 40 concurrent requests
    # - DB pool: 5-20 connections per worker
    command: uvicorn app.main:app --host 0.0.0.0 --port ${DEMO_AGENT_PORT:-9090} --workers ${UVICORN_WORKERS:-4}
    networks:
      - docker-config

networks:
  docker-config:
    external: true
