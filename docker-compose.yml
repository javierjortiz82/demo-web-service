services:
  demo-agent:
    build: .
    container_name: ${COMPOSE_PROJECT_NAME:-demo}-agent
    user: "${DOCKER_UID:-1000}:${DOCKER_GID:-1000}"
    env_file: .env
    ports:
      - "${DEMO_AGENT_PORT:-9090}:${DEMO_AGENT_PORT:-9090}"
    volumes:
      - ./app:/app/app
      - ./credentials:/app/credentials
      - ./prompts:/app/prompts
      - demo-logs:${LOG_DIR:-/logs}
    environment:
      - PYTHONUNBUFFERED=${PYTHONUNBUFFERED:-1}
      - DEMO_AGENT_HOST=${DEMO_AGENT_HOST:-0.0.0.0}
      - DEMO_AGENT_PORT=${DEMO_AGENT_PORT:-9090}
      - LOG_DIR=${LOG_DIR:-/logs}
      - GOOGLE_APPLICATION_CREDENTIALS=${CONTAINER_CREDENTIALS_PATH:-/app/credentials/google-sa.json}
      - GCP_PROJECT_ID=${GCP_PROJECT_ID}
      - GCP_LOCATION=${GCP_LOCATION:-us-central1}
      - MODEL=${MODEL:-gemini-2.5-flash}
      - DATABASE_URL=${DATABASE_URL}
      # Concurrency settings
      - MAX_CONCURRENT_REQUESTS=${MAX_CONCURRENT_REQUESTS:-10}
      # Database pool settings
      - DB_POOL_MIN_SIZE=${DB_POOL_MIN_SIZE:-5}
      - DB_POOL_MAX_SIZE=${DB_POOL_MAX_SIZE:-20}
      - DB_COMMAND_TIMEOUT=${DB_COMMAND_TIMEOUT:-60}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${DEMO_AGENT_PORT:-9090}/health"]
      interval: ${HEALTHCHECK_INTERVAL:-30s}
      timeout: ${HEALTHCHECK_TIMEOUT:-10s}
      retries: ${HEALTHCHECK_RETRIES:-3}
      start_period: ${HEALTHCHECK_START_PERIOD:-15s}
    restart: unless-stopped
    logging:
      driver: "${LOG_DRIVER:-json-file}"
      options:
        max-size: "${LOG_MAX_SIZE:-10m}"
        max-file: "${LOG_MAX_FILE:-3}"
    # Concurrency config:
    # - UVICORN_WORKERS: Number of worker processes (default: 4 for production)
    # - Each worker has a ThreadPoolExecutor with 10 threads for Gemini API calls
    # - Total concurrent Gemini calls = WORKERS * 10 = 40 concurrent requests
    # - DB pool: 5-20 connections per worker
    command: >
      uvicorn app.main:app
      --host ${DEMO_AGENT_HOST:-0.0.0.0}
      --port ${DEMO_AGENT_PORT:-9090}
      --workers ${UVICORN_WORKERS:-4}
    networks:
      - docker-config

volumes:
  demo-logs:
    name: ${COMPOSE_PROJECT_NAME:-demo}-agent-logs

networks:
  docker-config:
    external: true
